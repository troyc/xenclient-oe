From 365725b5d57ea29e1ff86950c603a11eb6f9cf25 Mon Sep 17 00:00:00 2001
From: Eric Chanudet <chanudete@ainfosec.com>
Date: Mon, 13 Aug 2018 13:58:44 -0400
Subject: [PATCH 6/9] tpm2.0: Perform orderly shutdown.

Avoid TPM_PT_LOCKOUT_COUNTER being incremented unnecessarily.

Signed-off-by: Chris Rogers <rogersc@ainfosec.com>
---
 tboot/common/tboot.c  |  6 ++++++
 tboot/common/tpm_20.c | 16 ++++++++++++++++
 tboot/include/tpm.h   |  3 ++-
 3 files changed, 24 insertions(+), 1 deletion(-)

diff --git a/tboot/common/tboot.c b/tboot/common/tboot.c
index d1402e7..7f0cfbd 100644
--- a/tboot/common/tboot.c
+++ b/tboot/common/tboot.c
@@ -680,6 +680,12 @@ void shutdown(void)
             if (tpm_fp->save_state(tpm, tpm->cur_loc) != 0) {
                 printk(TBOOT_ERR"failed to save TPM state\n");
             }
+        } else if ( _tboot_shared.shutdown_type == TB_SHUTDOWN_REBOOT ||
+                   _tboot_shared.shutdown_type == TB_SHUTDOWN_HALT ||
+                   _tboot_shared.shutdown_type == TB_SHUTDOWN_S5) {
+            if(tpm->major == TPM20_VER_MAJOR) {
+                tpm_fp->shutdown(tpm, tpm->cur_loc);
+            }
         }
 
         /* scrub any secrets by clearing their memory, then flush cache */
diff --git a/tboot/common/tpm_20.c b/tboot/common/tpm_20.c
index 475ab83..ddbbebc 100644
--- a/tboot/common/tpm_20.c
+++ b/tboot/common/tpm_20.c
@@ -2581,6 +2581,21 @@ static bool tpm20_get_random(struct tpm_if *ti, uint32_t locality,
     return true;
 }
 
+static uint32_t tpm20_shutdown(struct tpm_if *ti, uint32_t locality)
+{
+    u32 ret;
+
+    if ( ti == NULL )
+        return false;
+
+    ret = _tpm20_shutdown(locality, TPM_SU_CLEAR);
+    if ( ret != TPM_RC_SUCCESS ) {
+        printk(TBOOT_WARN"TPM: Shutdown, return value = %08X\n", ret);
+        ti->error = ret;
+    }
+
+    return ret;
+}
 static uint32_t tpm20_save_state(struct tpm_if *ti, uint32_t locality)
 {
     u32 ret;
@@ -2867,6 +2882,7 @@ const struct tpm_if_fp tpm_20_if_fp = {
     .verify_creation = tpm20_verify_creation,
     .get_random = tpm20_get_random,
     .save_state = tpm20_save_state,
+    .shutdown = tpm20_shutdown,
     .cap_pcrs = tpm20_cap_pcrs,
     .context_save = tpm20_context_save,
     .context_load = tpm20_context_load,
diff --git a/tboot/include/tpm.h b/tboot/include/tpm.h
index fbbd556..b0deed3 100644
--- a/tboot/include/tpm.h
+++ b/tboot/include/tpm.h
@@ -483,7 +483,8 @@ struct tpm_if_fp {
     bool (*get_random)(struct tpm_if *ti, u32 locality, u8 *random_data, u32 *data_size);
 
     uint32_t (*save_state)(struct tpm_if *ti, u32 locality);
-    
+    uint32_t (*shutdown)(struct tpm_if *ti, u32 locality);
+
     bool (*context_save)(struct tpm_if *ti, u32 locality, u32 handle, void *context_saved);
     bool (*context_load)(struct tpm_if *ti, u32 locality, void *context_saved, u32 *handle);
     bool (*context_flush)(struct tpm_if *ti, u32 locality, u32 handle);
-- 
2.25.1

